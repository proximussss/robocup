================================================================================
                    SOCCER AI - SYSTEM ARCHITECTURE
================================================================================

                              GAME LOOP (20ms cycles)
                                       |
                                       v
                    +----------------------------------+
                    |     agent/Agent.py               |
                    |     think_and_send()             |
                    +----------------------------------+
                                       |
                                       v
                    +----------------------------------+
                    |     select_skill()               |
                    |     (Main Decision Function)     |
                    +----------------------------------+
                                       |
            +------------------------+--------------------------+
            |                        |                          |
            v                        v                          v
    +-------------+        +------------------+       +------------------+
    | Game Mode   |        | Strategy Data    |       | World State      |
    | Detection   |        | Collection       |       | (ball, players)  |
    +-------------+        +------------------+       +------------------+
            |                        |                          |
            +------------------------+--------------------------+
                                     |
                                     v
================================================================================
                         STRATEGY LAYER
================================================================================

    +---------------------------------------------------------------+
    |                   FORMATION GENERATION                        |
    |  formation/DynamicFormation.py                                |
    |                                                               |
    |  generate_formation(ball_pos, game_mode, is_our_piece)       |
    |                                                               |
    |  Ball in attacking third  -> Push forward                    |
    |  Ball in defensive third  -> Drop back                       |
    |  Set pieces              -> Special formations               |
    +---------------------------------------------------------------+
                                     |
                                     v
    +---------------------------------------------------------------+
    |                   ROLE ASSIGNMENT                             |
    |  strategy/Assignment.py                                       |
    |                                                               |
    |  role_assignment(teammate_pos, formation_pos)                |
    |                                                               |
    |  Uses Gale-Shapley Algorithm:                                |
    |  1. Calculate distance preferences                           |
    |  2. Players propose to formations                            |
    |  3. Formations accept/reject                                 |
    |  4. Return stable matching                                   |
    +---------------------------------------------------------------+
                                     |
                                     v
    +---------------------------------------------------------------+
    |                   TACTICAL ANALYSIS                           |
    |  strategy/DecisionMaker.py                                    |
    |                                                               |
    |  - am_i_closest_to_ball()                                    |
    |  - is_opponent_nearby()                                      |
    |  - get_best_pass_target()                                    |
    |  - should_pass()                                             |
    |  - count_teammates/opponents_in_radius()                     |
    +---------------------------------------------------------------+
                                     |
                                     v
================================================================================
                         BEHAVIOR SELECTION
================================================================================

                        Am I closest to ball?
                                |
                +---------------+---------------+
                |                               |
               YES                             NO
                |                               |
                v                               v
    +-----------------------+       +-----------------------+
    |   ACTIVE PLAYER       |       |  SUPPORTING PLAYER    |
    |   (Attack Ball)       |       |  (Move to Formation)  |
    +-----------------------+       +-----------------------+
    |                       |       |                       |
    | TacticalStrategies.py |       | TacticalStrategies.py |
    |                       |       |                       |
    | get_attacking_action()|       | get_supporting_action()|
    +-----------------------+       +-----------------------+
                |                               |
                v                               v
    +-----------------------+       +-----------------------+
    | Decision Tree:        |       | Role-Based:           |
    |                       |       |                       |
    | 1. In danger?         |       | 1. Goalkeeper?        |
    |    -> Clear ball      |       |    -> Guard goal      |
    |                       |       |                       |
    | 2. Under pressure?    |       | 2. Defender?          |
    |    -> Pass            |       |    -> Defensive pos   |
    |                       |       |                       |
    | 3. Close to goal?     |       | 3. Midfielder?        |
    |    -> Shoot           |       |    -> Support         |
    |                       |       |                       |
    | 4. Have space?        |       | 4. Forward?           |
    |    -> Dribble         |       |    -> Attack pos      |
    +-----------------------+       +-----------------------+
                |                               |
                +---------------+---------------+
                                |
                                v
================================================================================
                           ACTION EXECUTION
================================================================================

                        Return Action:
                                |
                +---------------+---------------+
                |                               |
                v                               v
    +-----------------------+       +-----------------------+
    |   move()              |       |   kickTarget()        |
    +-----------------------+       +-----------------------+
    |                       |       |                       |
    | - target_2d           |       | - my_position         |
    | - orientation         |       | - target_position     |
    | - avoid_obstacles     |       | - kick_direction      |
    |                       |       | - kick_distance       |
    +-----------------------+       +-----------------------+
                |                               |
                +---------------+---------------+
                                |
                                v
                        Behavior Execution
                        (Walk, Basic_Kick, etc.)
                                |
                                v
                        Send to Server


================================================================================
                      DATA FLOW DIAGRAM
================================================================================

World State --> Strategy.py --> strategyData
                                      |
                                      +-> teammate_positions
                                      +-> opponent_positions
                                      +-> ball_2d
                                      +-> ball_dir
                                      +-> active_player_unum
                                      +-> play_mode
                                      
                                      |
                                      v
                              GameModeHandler
                                      |
                                      v
                              DynamicFormation
                                      |
                                      v
                              role_assignment()
                                      |
                                      v
                              DecisionMaker
                                      |
                                      v
                              TacticalStrategies
                                      |
                                      v
                              Action (move/kick)


================================================================================
                      MODULE DEPENDENCIES
================================================================================

Agent.py
  |
  +-- Strategy.py (game state)
  +-- Assignment.py (role assignment)
  +-- GameModeHandler.py (mode detection)
  +-- DecisionMaker.py (tactical decisions)
  +-- TacticalStrategies.py (behaviors)
  +-- DynamicFormation.py (formations)
  +-- Formation.py (static formations)


================================================================================
                      EXECUTION TIMELINE (Single Cycle)
================================================================================

Time    | Action
--------|---------------------------------------------------------------
0ms     | think_and_send() called
        |
1ms     | Collect world state -> Strategy object
        |
2ms     | Detect game mode -> GameModeHandler
        |
3ms     | Generate dynamic formation -> DynamicFormation
        |
4-6ms   | Assign roles -> role_assignment() [Gale-Shapley]
        |
7ms     | Create decision maker -> DecisionMaker
        |
8ms     | Determine if active player
        |
9-12ms  | Select action -> TacticalStrategies
        |    - Evaluate situation
        |    - Choose best action
        |
13-15ms | Execute action -> move() or kickTarget()
        |
16-18ms | Generate motor commands -> Behavior system
        |
19ms    | Send commands to server
        |
20ms    | Cycle complete, wait for next cycle
        |

Total: ~20ms per cycle (well within limits)


================================================================================
                      KEY ALGORITHMS
================================================================================

1. GALE-SHAPLEY (Role Assignment)
   - Input: Player positions, Formation positions
   - Output: Stable matching (player -> position)
   - Complexity: O(nÂ²)
   - Guarantees: No blocking pairs

2. DYNAMIC FORMATION
   - Input: Ball position, Game mode
   - Output: 5 formation positions
   - Adapts: Forward/back based on ball
   - Complexity: O(1)

3. PASS EVALUATION
   - Input: Teammate positions, Opponent positions
   - Output: Best pass target with score
   - Considers: Distance to goal, pressure, positioning
   - Complexity: O(n)

4. ROLE DETECTION
   - Input: Formation position
   - Output: Role (GK, Defender, Midfielder, Forward)
   - Based on: X-coordinate of position
   - Complexity: O(1)


================================================================================
                      CONFIGURATION & TUNING
================================================================================

Passing Aggressiveness:
  File: strategy/TacticalStrategies.py
  Variable: min_opponent_ball_dist threshold
  Current: 1.5m
  Adjust: Lower = less passing, Higher = more passing

Shooting Distance:
  File: strategy/TacticalStrategies.py
  Function: _attack_goal()
  Current: 8m
  Adjust: Increase for longer shots

Formation Positions:
  File: formation/DynamicFormation.py
  Function: _dynamic_play_formation()
  Adjust: defense_x, midfield_x values

Defensive Tendency:
  File: formation/DynamicFormation.py
  Adjust: Position calculations based on ball_x


================================================================================
                      ERROR HANDLING & ROBUSTNESS
================================================================================

Issue                    | Handling
------------------------|------------------------------------------------
Missing teammate data   | Check for None, use default positions
Fallen players          | Excluded via state_fallen check
Delayed updates         | Timestamp checking (360ms threshold)
No pass targets         | Default to dribbling/shooting
Division by zero        | Check distance > 0 before normalize
Server timeout          | Keep processing < 20ms per cycle


================================================================================

